<a href="/admin/global-notification/new">
  <p class="btn btn-default">通知設定の追加</p>
</a>
<h2>通知設定一覧</h2>

{% set tags = {
  pageCreate: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="Page Create"><i class="icon-doc"></i> CREATE</span>',
  pageEdit: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="Page Edit"><i class="icon-doc"></i> EDIT</span>',
  pageDelete: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="Page Delte"><i class="icon-doc"></i> DELETE</span>',
  pageMove: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="Page Move"><i class="icon-doc"></i> MOVE</span>',
  pageLike: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="Page Like"><i class="icon-doc"></i> LIKE</span>',
  comment: '<span class="label label-info" data-toggle="tooltip" data-placement="top" title="New Comment"><i class="icon-fw icon-bubbles"></i> POST</span>'
} %}

<table class="table table-bordered">
  <thead>
    <th>ON/OFF</th>
    <th>Trigger Path (expression with <code>*</code> is supported)</th>
    <th>Trigger Events</th>
    <th>Notify To</th>
    <th></th>
  </thead>
  <tbody class="admin-notif-list">
    {% for globalNotif in globalNotifications %}
    {% set detailPageUrl = '/admin/global-notification/' + globalNotif.id %}
    <tr>
      <td class="align-middle">
        <label class="switch">
          <input type="checkbox" class="isEnabledToggle" {% if globalNotif.isEnabled %}checked{% endif %}>
          <span class="slider round"></span>
        </label>
      </td>
      <td>
        {{ globalNotif.triggerPath }}
      </td>
      <td style="max-width: 200px;">
        {% for event in globalNotif.triggerEvents %}
          {{ tags[event] | safe }}
        {% endfor %}
      </td>
      <td>
        {% if globalNotif.__t == 'mail' %}<span data-toggle="tooltip" data-placement="top" title="Email"><i class="ti-email"></i> {{ globalNotif.toEmail }}</span>
        {% elseif globalNotif.__t == 'slack' %}<span data-toggle="tooltip" data-placement="top" title="Slack"><i class="fa fa-slack"></i> {{ globalNotif.slackChannels }}</span>
        {% endif %}
      </td>
      <td>
        <div class="btn-group admin-group-menu">
          <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
            <i class="icon-settings"></i> <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="{{ detailPageUrl }}">
                <i class="icon-fw icon-note"></i> 編集
              </a>
            </li>

            <li class="btn-delete">
              <a href="#"
                  data-setting-id="{{ globalNotif.id }}"
                  data-target="#admin-delete-global-notification"
                  data-toggle="modal">
                <i class="icon-fw icon-fire text-danger"></i> 削除する
              </a>
            </li>

          </ul>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="modal fade" id="admin-delete-global-notification">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <div class="modal-title">
            <i class="icon icon-fire"></i> Delete Global Notification Setting
          </div>
        </div>

        <div class="modal-body">
          <span class="text-danger">
            削除すると元に戻すことはできませんのでご注意ください。
          </span>
        </div>
        <div class="modal-footer">
          <form action="#" method="post" id="admin-global-notification-setting-delete" class="text-right">
            <input type="hidden" name="setting-id" value="">
            <input type="hidden" name="_csrf" value="{{ csrf() }}">
            <button type="submit" value="" class="btn btn-sm btn-danger">
              <i class="icon icon-fire"></i> 削除
            </button>
          </form>
        </div>

      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>

<script>
  $(".btn-delete").on("click", function(event) {
    var id = $(event.currentTarget).find("a").data("setting-id");
    $("#admin-global-notification-setting-delete").attr("action", "/admin/global-notification/" + id + "/remove");
  });

  $(".isEnabledToggle").on("change", function(event) {
    var $targetRow = $(event.currentTarget).closest("tr");
    var id = $targetRow.data("updatepost-id");
    var isEnabled = !$targetRow.find(".isEnabledToggle").is(':checked');
    $.post('/_api/admin/global-notification/toggleIsEnabled?id=' + id + '&isEnabled=' + isEnabled, function(res) {
      if (res.ok) {
        $('.admin-notification > .row > .col-md-9').prepend(
          '<div class=\"alert alert-success\">Successfully Updated</div>'
        );
        $message = $('.admin-notification > .row > .col-md-9 > .alert.alert-success');
        setTimeout(function()
            {
              $message.fadeOut({
                complete: function() {
                  $message.remove();
                }
              });
            }, 2000);
      }
      else {
        $('.admin-notification > .row > .col-md-9').prepend(
          '<div class=\"alert alert-danger\">Error occurred in deleting global notifcation setting.</div>'
        );
        location.reload();
      }
    });
  });
</script>
